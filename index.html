<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TreasureLink</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #ABD6A0 0%, #81B474 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #ABD6A0 0%, #81B474 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 16px;
      margin-bottom: 30px;
      line-height: 1.5;
    }

    .button {
      display: inline-block;
      background: linear-gradient(135deg, #ABD6A0 0%, #81B474 100%);
      color: white;
      padding: 15px 40px;
      border-radius: 30px;
      text-decoration: none;
      font-size: 18px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 20px;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .loading {
      color: #999;
      font-size: 14px;
      margin-top: 20px;
    }

    .store-buttons {
      display: none;
      margin-top: 20px;
    }

    .store-button {
      display: inline-block;
      margin: 10px;
    }

    .store-button img {
      height: 45px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo">=</div>
    <h1>TreasureLink</h1>
    <p class="subtitle">앱을 여는 중입니다<br>잠시만 기다려주세요</p>

    <a href="#" id="openApp" class="button">앱 열기</a>

    <div class="store-buttons" id="storeButtons">
      <a href="https://apps.apple.com/app/treasurelink/id6746151115" class="store-button" id="appStore">
        <img
          src="https://tools.applemediaservices.com/api/badges/download-on-the-app-store/black/ko-kr?size=250x83&amp;releaseDate=1735171200"
          alt="Download on the App Store">
      </a>
      <a href="https://play.google.com/store/apps/details?id=com.wb.treasure_link" class="store-button" id="playStore">
        <img src="https://play.google.com/intl/en_us/badges/static/images/badges/ko_badge_web_generic.png"
          alt="Get it on Google Play">
      </a>
    </div>

    <p class="loading" id="loadingText">앱을 여는 중...</p>
  </div>

  <script>
    (function () {
      // App Store & Play Store URLs (기본값)
      const baseAppStoreUrl = 'https://apps.apple.com/app/treasurelink/id6746151115';
      const basePlayStoreUrl = 'https://play.google.com/store/apps/details?id=com.wb.treasure_link';

      // URL 파라미터 파싱
      function getURLParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          source: params.get('utm_source') || params.get('source'),
          campaign: params.get('utm_campaign') || params.get('campaign'),
          medium: params.get('utm_medium') || params.get('medium'),
          ad_id: params.get('ad_id'),
          adset_id: params.get('adset_id'),
          click_id: params.get('fbclid') || params.get('gclid') || params.get('click_id'),
          term: params.get('utm_term') || params.get('term'),
          referrer_url: window.location.href
        };
      }


      function getMobileOS() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;

        if (/android/i.test(userAgent)) {
          return 'android';
        }

        if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
          return 'ios';
        }

        return 'other';
      }

      function showStoreButtons(message) {
        const loadingText = document.getElementById('loadingText');
        const storeButtons = document.getElementById('storeButtons');

        if (message) {
          loadingText.textContent = message;
        }

        loadingText.style.display = 'block';
        storeButtons.style.display = 'block';
      }

      // UTM 파라미터를 포함한 스토어 URL 생성
      function buildStoreUrl(os) {
        const params = getURLParams();

        if (os === 'ios') {
          return baseAppStoreUrl;
        } else if (os === 'android') {
          const referrerParams = [];
          if (params.source) referrerParams.push(`utm_source=${encodeURIComponent(params.source)}`);
          if (params.campaign) referrerParams.push(`utm_campaign=${encodeURIComponent(params.campaign)}`);
          if (params.medium) referrerParams.push(`utm_medium=${encodeURIComponent(params.medium)}`);
          if (params.term) referrerParams.push(`utm_term=${encodeURIComponent(params.term)}`);
          if (params.click_id) referrerParams.push(`click_id=${encodeURIComponent(params.click_id)}`);

          if (referrerParams.length > 0) {
            const referrerString = referrerParams.join('&');
            return `${basePlayStoreUrl}&referrer=${encodeURIComponent(referrerString)}`;
          }
          return basePlayStoreUrl;
        }
        return null;
      }

      function redirectToStore(os) {
        const storeUrl = buildStoreUrl(os);
        if (storeUrl) {
          window.location.href = storeUrl;
        }
      }

      // iOS: 앱 스킴 + 타이머 fallback
      function tryOpenApp(os, trigger = 'auto') {
        if (os !== 'ios' && os !== 'android') {
          showStoreButtons('모바일 기기에서 접속해주세요');
          return;
        }

        const loadingText = document.getElementById('loadingText');
        const storeButtons = document.getElementById('storeButtons');

        loadingText.textContent = trigger === 'auto'
          ? '앱을 여는 중입니다...'
          : '앱 실행을 다시 시도하는 중입니다...';

        loadingText.style.display = 'block';
        storeButtons.style.display = 'none';

        const fallbackDelay = trigger === 'auto' ? 2000 : 1500;

        if (os === 'android') {
          const playStoreUrl = buildStoreUrl('android');
          const androidIntentUrl =
            `intent://treasurelink.com/#Intent;scheme=treasurelink;package=com.wb.treasure_link;` +
            `S.browser_fallback_url=${encodeURIComponent(playStoreUrl)};end`;
          window.location.href = androidIntentUrl;
          return;
        }

        if (os === 'ios') {
          const appSchemeUrl = `treasurelink://`;
          const storeUrl = buildStoreUrl('ios');

          const timer = setTimeout(function () {
            loadingText.textContent = '앱이 설치되어 있지 않아 스토어로 이동합니다...';
            if (storeUrl) {
              window.location.href = storeUrl;
            }
          }, fallbackDelay);

          const onPageHide = function () {
            clearTimeout(timer);
            window.removeEventListener('pagehide', onPageHide);
          };
          window.addEventListener('pagehide', onPageHide);

          // 앱 열기 시도
          window.location.href = appSchemeUrl;
        }
      }


      window.addEventListener('load', function () {
        const os = getMobileOS();
        trackClick(os);

        if (os === 'android') {
          setTimeout(function () { tryOpenApp(os); }, 500);
        } else if (os === 'ios') {
          document.getElementById('loadingText').textContent = '앱을 열려면 버튼을 눌러주세요';
        } else {
          showStoreButtons('모바일 기기에서 접속해주세요');
        }

        document.getElementById('openApp').addEventListener('click', function (e) {
          e.preventDefault();
          tryOpenApp(os, 'user');
        });
      });
    })();
  </script>
</body>

</html>
